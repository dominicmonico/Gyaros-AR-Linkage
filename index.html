<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GyARos Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 12px; display:flex; flex-direction:column; align-items:center; }
    #reader { width:100%; max-width:640px; height:480px; background:#000; }
    #toast {
      position: fixed; left:50%; transform:translateX(-50%);
      bottom:20px; background:rgba(0,0,0,0.85); color:#fff; padding:10px 14px; border-radius:8px;
      display:none; align-items:center; gap:12px; min-width:260px; justify-content:space-between;
    }
    #toast small { opacity:0.9; display:block; font-size:13px; max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    button { padding:8px 10px; font-size:14px; }
    #status { margin:8px 0; color:#333; font-size:14px; }
  </style>
</head>
<body>
  <img src="GyARos Logo black glow.png" style="width:10%;height:auto;"></img>
  <div id="reader"></div>
  <div id="status">Initializing camera…</div>

  <div id="toast" role="status" aria-live="polite">
    <div>
      <div id="toastMsg"><strong>Opening</strong></div>
      <small id="toastUrl"></small>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="countdown" style="font-weight:600">1.0s</div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>
  <script>
    // ---- CONFIG: set allowed targets ----
    // Add allowed hostnames or exact URLs. Hostname entries allow any path under that host.
    const REDIRECT_DELAY = 0; // seconds before redirect (short visible cue)
    const REUSE_DEBOUNCE_MS = 1200; // avoid duplicate handling
    const QR_BOXSIZE = 100;
    const CONFIG_DEFAULT = { fps: { ideal: 30 }, qrbox: QR_BOXSIZE, aspectRatio: 16/9, width: { ideal: 1920, max: 2560 }, height: { ideal: 1080, max: 1440 } };

    // ---- UI refs ----
    const readerId = "reader";
    const statusEl = document.getElementById('status');
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastUrl = document.getElementById('toastUrl');
    const countdownEl = document.getElementById('countdown');

    let html5QrCode = null;
    let lastHandled = null;
    let pendingTimer = null;
    let remaining = REDIRECT_DELAY;

    function logStatus(s) { statusEl.textContent = s; }

    function showToastFor(url) {
      toastUrl.textContent = url;
      toastMsg.innerHTML = '<strong>Opening</strong>';
      countdownEl.textContent = remaining.toFixed(1) + 's';
      toast.style.display = 'flex';
    }
    function hideToast() { toast.style.display = 'none'; }

    function clearPending() {
      if (pendingTimer) {
        clearInterval(pendingTimer);
        pendingTimer = null;
      }
    }

    function startCountdownAndRedirect(url) {
      remaining = REDIRECT_DELAY;
      showToastFor(url);
      pendingTimer = setInterval(() => {
        remaining -= 0.1;
        if (remaining <= 0) {
          clearPending();
          hideToast();
          // stop camera then go to location
          if (html5QrCode) {
            html5QrCode.stop().catch(()=>{});
          }
          location.assign(url);
        } else {
          countdownEl.textContent = remaining.toFixed(1) + 's';
        }
      }, 100);
    }

    // Called on each successful scan
    async function onScanSuccess(decodedText) {
      if (!decodedText) return;

      const now = Date.now();
      if (lastHandled && (now - lastHandled.time < REUSE_DEBOUNCE_MS) && lastHandled.text === decodedText) return;
      lastHandled = { text: decodedText, time: now };

      // normalize to a full https URL if needed
      let target = decodedText.trim();
      if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(target)) target = 'https://' + target;

      logStatus('QR scanned — redirecting…');
      startCountdownAndRedirect(target);
    }

    // Try to start camera on load
    async function createAndStartScanner() {
      const config = CONFIG_DEFAULT;
      try {
        if(html5QrCode){
          try{await html5QrCode.stop();}
          catch{}
          try{html5QrCode.clear();}
          catch{}
          html5QrCode = null;
        }
        html5QrCode = new Html5Qrcode(readerId, /* verbose= */ false);
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          (decodedText) => onScanSuccess(decodedText),
          (err) => {}
        );
        logStatus('Camera started. Point at a QR code.');
      } catch (err) {
        logStatus('Could not start camera: ' + err);
      }
    }

    async function stopAndTidyScanner() {
      if (!html5QrCode) return;
      try{await html5QrCode.stop(); } 
      catch{}
      try{html5QrCode.clear();} 
      catch{}
      html5QrCode = null;
    }

    window.addEventListener('pageshow', (evt) => {
      // evt.persisted is true when restored from bfcache, but we want to start in both cases
      createAndStartScanner();
    });

    window.addEventListener('pagehide', (evt) => {
      // evt.persisted is true when restored from bfcache, but we want to start in both cases
      stopAndTidyScanner();
      clearPending();
      hideToast();
    });
  </script>
</body>
</html>
