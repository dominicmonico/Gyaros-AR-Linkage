<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto QR Scanner (whitelist)</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 12px; display:flex; flex-direction:column; align-items:center; }
    #reader { width:100%; max-width:640px; height:480px; background:#000; }
    #toast {
      position: fixed; left:50%; transform:translateX(-50%);
      bottom:20px; background:rgba(0,0,0,0.85); color:#fff; padding:10px 14px; border-radius:8px;
      display:none; align-items:center; gap:12px; min-width:260px; justify-content:space-between;
    }
    #toast small { opacity:0.9; display:block; font-size:13px; max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    button { padding:8px 10px; font-size:14px; }
    #status { margin:8px 0; color:#333; font-size:14px; }
  </style>
</head>
<body>
  <h3>GyARos Scanner</h3>
  <div id="reader"></div>
  <div id="status">Initializing camera…</div>

  <div id="toast" role="status" aria-live="polite">
    <div>
      <div id="toastMsg"><strong>Opening</strong></div>
      <small id="toastUrl"></small>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="countdown" style="font-weight:600">1.0s</div>
      <button id="cancelBtn">Cancel</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>
  <script>
    // ---- CONFIG: set allowed targets ----
    // Add allowed hostnames or exact URLs. Hostname entries allow any path under that host.
    const REDIRECT_DELAY = 1.0; // seconds before redirect (short visible cue)
    const REUSE_DEBOUNCE_MS = 1200; // avoid duplicate handling

    // ---- UI refs ----
    const readerId = "reader";
    const statusEl = document.getElementById('status');
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastUrl = document.getElementById('toastUrl');
    const countdownEl = document.getElementById('countdown');
    const cancelBtn = document.getElementById('cancelBtn');

    let html5QrCode = null;
    let lastHandled = null;
    let pendingTimer = null;
    let remaining = REDIRECT_DELAY;

    function logStatus(s) { statusEl.textContent = s; }

    function showToastFor(url) {
      toastUrl.textContent = url;
      toastMsg.innerHTML = '<strong>Opening</strong>';
      countdownEl.textContent = remaining.toFixed(1) + 's';
      toast.style.display = 'flex';
    }
    function hideToast() { toast.style.display = 'none'; }

    function clearPending() {
      if (pendingTimer) {
        clearInterval(pendingTimer);
        pendingTimer = null;
      }
    }

    function startCountdownAndRedirect(url) {
      clearPending();
      remaining = REDIRECT_DELAY;
      showToastFor(url);
      pendingTimer = setInterval(() => {
        remaining -= 0.1;
        if (remaining <= 0) {
          clearPending();
          hideToast();
          // stop camera then replace location
          if (html5QrCode) {
            html5QrCode.stop().catch(()=>{});
          }
          location.replace(url);
        } else {
          countdownEl.textContent = remaining.toFixed(1) + 's';
        }
      }, 100);
    }

    cancelBtn.addEventListener('click', () => {
      clearPending();
      hideToast();
      logStatus('Redirect canceled.');
    });

    // Called on each successful scan
    async function onScanSuccess(decodedText) {
      if (!decodedText) return;

      const now = Date.now();
      if (lastHandled && (now - lastHandled.time < REUSE_DEBOUNCE_MS) && lastHandled.text === decodedText) return;
      lastHandled = { text: decodedText, time: now };

      // normalize to a full https URL if needed
      let target = decodedText.trim();
      if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(target)) target = 'https://' + target;

      logStatus('QR scanned — redirecting…');
      startCountdownAndRedirect(target);
    }

    // Try to start camera on load
    window.addEventListener('load', async () => {
      try {
        html5QrCode = new Html5Qrcode(readerId, /* verbose= */ false);
        const config = { fps: 30, qrbox: 100};

        // Attempt to start immediately
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          (decodedText, result) => {
            onScanSuccess(decodedText);
          },
          (err) => {
            // per-frame decode failure; ignored normally
          }
        );
        logStatus('Camera started. Point at a QR code.');
      } catch (err) {
        logStatus('Could not start camera: ' + err);
      }
    });

    // stop camera when leaving page
    window.addEventListener('pagehide', () => {
      if (html5QrCode) html5QrCode.stop().catch(()=>{});
    });
  </script>
</body>
</html>
